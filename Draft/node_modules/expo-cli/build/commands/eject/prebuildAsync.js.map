{"version":3,"sources":["../../../src/commands/eject/prebuildAsync.ts"],"names":["prebuildAsync","projectRoot","platforms","options","exp","pkg","tempDir","temporary","directory","hasNewProjectFiles","needsPodInstall","hasNewDependencies","shouldInstall","install","packageManager","CreateApp","resolvePackageManager","npm","yarn","clean","applyingAndroidConfigStep","logNewSection","managedConfig","WarningAggregator","hasWarningsAndroid","hasWarningsIOS","stopAndPersist","symbol","text","chalk","red","succeed","podsInstalled","includes","installCocoaPodsAsync","Log","debug","sdkVersion","Object","keys","_internal","pluginHistory","nodeInstall","podInstall","legacyUpdates","hasAssetBundlePatterns","hasOwnProperty"],"mappings":"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","sourcesContent":["import { ModPlatform, WarningAggregator } from '@expo/config-plugins';\nimport chalk from 'chalk';\nimport temporary from 'tempy';\n\nimport Log from '../../log';\nimport * as CreateApp from '../utils/CreateApp';\nimport { usesOldExpoUpdatesAsync } from '../utils/ProjectUtils';\nimport { logConfigWarningsAndroid, logConfigWarningsIOS } from '../utils/logConfigWarnings';\nimport configureProjectAsync from './configureProjectAsync';\nimport { createNativeProjectsFromTemplateAsync } from './createNativeProjectsFromTemplateAsync';\nimport { ensureConfigAsync } from './ensureConfigAsync';\nimport { installNodeDependenciesAsync } from './installNodeDependenciesAsync';\nimport { assertPlatforms, ensureValidPlatforms } from './platformOptions';\nimport { warnIfDependenciesRequireAdditionalSetup } from './setupWarnings';\n\nexport type EjectAsyncOptions = {\n  verbose?: boolean;\n  force?: boolean;\n  install?: boolean;\n  packageManager?: 'npm' | 'yarn';\n  platforms: ModPlatform[];\n};\n\nexport type PrebuildResults = {\n  hasAssetBundlePatterns: boolean;\n  legacyUpdates: boolean;\n  hasNewProjectFiles: boolean;\n  platforms: ModPlatform[];\n  podInstall: boolean;\n  nodeInstall: boolean;\n  packageManager: string;\n};\n\n/**\n * Entry point into the prebuild process, delegates to other helpers to perform various steps.\n *\n * 1. Create native projects (ios, android)\n * 2. Install node modules\n * 3. Apply config to native projects\n * 4. Install CocoaPods\n */\nexport async function prebuildAsync(\n  projectRoot: string,\n  { platforms, ...options }: EjectAsyncOptions\n): Promise<PrebuildResults> {\n  platforms = ensureValidPlatforms(platforms);\n  assertPlatforms(platforms);\n\n  const { exp, pkg } = await ensureConfigAsync({ projectRoot, platforms });\n  const tempDir = temporary.directory();\n\n  const {\n    hasNewProjectFiles,\n    needsPodInstall,\n    hasNewDependencies,\n  } = await createNativeProjectsFromTemplateAsync({\n    projectRoot,\n    exp,\n    pkg,\n    tempDir,\n    platforms,\n  });\n\n  // Install node modules\n  const shouldInstall = options?.install !== false;\n\n  const packageManager = CreateApp.resolvePackageManager({\n    install: shouldInstall,\n    npm: options?.packageManager === 'npm',\n    yarn: options?.packageManager === 'yarn',\n  });\n\n  if (shouldInstall) {\n    await installNodeDependenciesAsync(projectRoot, packageManager, {\n      // We delete the dependencies when new ones are added because native packages are more fragile.\n      // npm doesn't work well so we always run the cleaning step when npm is used in favor of yarn.\n      clean: hasNewDependencies || packageManager === 'npm',\n    });\n  }\n\n  // Apply Expo config to native projects\n  const applyingAndroidConfigStep = CreateApp.logNewSection('Config syncing');\n  const managedConfig = await configureProjectAsync({\n    projectRoot,\n    platforms,\n  });\n  if (WarningAggregator.hasWarningsAndroid() || WarningAggregator.hasWarningsIOS()) {\n    applyingAndroidConfigStep.stopAndPersist({\n      symbol: '⚠️ ',\n      text: chalk.red('Config synced with warnings that should be fixed:'),\n    });\n    logConfigWarningsAndroid();\n    logConfigWarningsIOS();\n  } else {\n    applyingAndroidConfigStep.succeed('Config synced');\n  }\n\n  // Install CocoaPods\n  let podsInstalled: boolean = false;\n  // err towards running pod install less because it's slow and users can easily run npx pod-install afterwards.\n  if (platforms.includes('ios') && shouldInstall && needsPodInstall) {\n    podsInstalled = await CreateApp.installCocoaPodsAsync(projectRoot);\n  } else {\n    Log.debug('Skipped pod install');\n  }\n\n  warnIfDependenciesRequireAdditionalSetup(\n    pkg,\n    exp.sdkVersion,\n    Object.keys(managedConfig._internal?.pluginHistory ?? {})\n  );\n\n  return {\n    packageManager,\n    nodeInstall: options.install === false,\n    podInstall: !podsInstalled,\n    legacyUpdates: await usesOldExpoUpdatesAsync(projectRoot),\n    platforms,\n    hasNewProjectFiles,\n    hasAssetBundlePatterns: exp.hasOwnProperty('assetBundlePatterns'),\n  };\n}\n"],"file":"prebuildAsync.js"}